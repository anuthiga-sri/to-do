<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Todo List</title>
    <link rel="stylesheet" href="../css/style.css" />
</head>

<body>
    <div class="todo-wrapper">
        <div class="admin-links">
            <a href="/" class="back">Back</a>
            <a href="/admin/reports">Reports</a>
        </div>
        <div class="todo-list-header">
            <h2>Todo Lists</h2>
        </div>

        <div class="board">
            <div class="todo-column" id="TODO" ondragover="allowDrop(event)" ondrop="drop(event, 'TODO')">
                <div class="column-title">ToDo</div>
            </div>
            <div class="todo-column" id="IN_PROGRESS" ondragover="allowDrop(event)" ondrop="drop(event, 'IN_PROGRESS')">
                <div class="column-title">In Progress</div>
            </div>
            <div class="todo-column" id="COMPLETED" ondragover="allowDrop(event)" ondrop="drop(event, 'COMPLETED')">
                <div class="column-title">Complete</div>
            </div>
        </div>

        <p class="error" id="errorMessage"></p>

        <div id="spinner-overlay" class="overlay">
            <div id="spinner" class="spinner"></div>
        </div>

        <div id="todo-history" class="history-section" style="display: none;">
            <h3 id="todo-history-heading">Todo History</h3>
            <div id="history-loader" class="spinner" style="display: none;"></div>
            <div id="history-content" class="timeline"></div>
            <div id="history-error"></div>
        </div>
    </div>

    <script>
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        }
    
        function getQueryParam(key) {
            const params = new URLSearchParams(window.location.search);
            return params.get(key);
        }
    
        async function loadHistory(todoId, title) {
            document.getElementById('todo-history-heading').innerHTML = title;
            const historySection = document.getElementById('todo-history');
            const historyContent = document.getElementById('history-content');
            const historyLoader = document.getElementById('history-loader');
            const errorMessage = document.getElementById('history-error');
    
            historySection.style.display = 'block';
            historyContent.innerHTML = '';
            historyLoader.style.display = 'block';
    
            try {
                const res = await fetch(`/api/todos/${todoId}/history`);
                const { todoHistories } = await res.json();
    
                if (!res.ok) {
                    errorMessage.textContent = todoHistories?.error || 'Failed to fetch todo history.';
                    errorMessage.style.color = 'red';
                    return;
                }
    
                historyContent.innerHTML = todoHistories.map(todoHistory =>
                    `
                    <div class="timeline-item">
                        <strong class="status-old">${todoHistory.oldStatus}</strong> â†’ 
                        <strong class="status-new">${todoHistory.newStatus}</strong>
                        <time>${formatDate(todoHistory.changedAt)}</time>
                    </div>
                    `
                ).join('');
            } catch (err) {
                errorMessage.textContent = err.message || 'Failed to fetch todo history.';
                errorMessage.style.color = 'red';
            } finally {
                historyLoader.style.display = 'none';
                historySection.scrollIntoView({ behavior: 'smooth' });
            }
        }
    
        async function fetchTodos() {
            const errorMessage = document.getElementById('errorMessage');
            const overlay = document.getElementById('spinner-overlay');
            const heading = document.querySelector('.todo-list-header h2');
            const backLink = document.querySelector('.admin-links a.back');
    
            const userId = getQueryParam('id');
            const userName = getQueryParam('name');
            overlay.style.display = 'flex';
    
            try {
                const endpoint = userId ? `/api/todos/${userId}` : `/api/todos/0`;
                const res = await fetch(endpoint);
                const { todoList } = await res.json();
    
                if (!res.ok || !todoList.length) {
                    errorMessage.textContent = 'No todos found.';
                    return;
                }
    
                if (userId && todoList.length > 0) {
                    heading.textContent = `Todo List of ${userName}`;
                    backLink.href = '/admin/reports';
                }
    
                todoList.forEach(todo => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <b>${todo.title}</b>
                        <div class="card-footer">
                            <span class="card-user">${userId ? '' : todo.user.name}</span>
                            <span class="card-date">${formatDate(todo.dueDate)}</span>
                        </div>
                    `;
    
                    if (todo.status !== 'TODO') {
                        card.style.cursor = 'pointer';
                        card.onclick = () => loadHistory(todo.id, todo.title);
                    }
    
                    const container = document.getElementById(todo.status || 'TODO');
                    if (container) container.appendChild(card);
                });
            } catch (err) {
                errorMessage.textContent = err.message || 'Error loading todos';
            } finally {
                overlay.style.display = 'none';
            }
        }
    
        fetchTodos();
    </script>
    
</body>

</html>